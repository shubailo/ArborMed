generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model Organization {
  id             String               @id @default(uuid())
  name           String
  questions      Question[]
  events         StudyEvent[]
  topics         Topic[]
  users          User[]
  courseProgress UserCourseProgress[]
  masteries      UserMastery[]
}

model User {
  id             String               @id @default(uuid())
  organizationId String
  email          String               @unique
  role           String               @default("STUDENT")
  masteryPoints  Int                  @default(0)
  rewardBalance  Int                  @default(0)
  createdAt      DateTime             @default(now())
  purchases      Purchase[]
  events         StudyEvent[]
  engineLogs     EngineDecisionLog[]
  studySessions  StudySession[]
  organization   Organization         @relation(fields: [organizationId], references: [id])
  bloomMasteries UserBloomMastery[]
  courseProgress UserCourseProgress[]
  inventory      UserInventory[]
  masteries      UserMastery[]
  roomItems      UserRoomItem[]
}

model Topic {
  id             String             @id @default(uuid())
  organizationId String
  name           String
  questions      Question[]
  events         StudyEvent[]
  organization   Organization       @relation(fields: [organizationId], references: [id])
  bloomMasteries UserBloomMastery[]
}

model Question {
  id             String         @id @default(uuid())
  organizationId String
  topicId        String
  bloomLevel     Int
  difficulty     Int            @default(1)
  questionType   String?
  status         String         @default("PUBLISHED")
  content        String
  explanation    String
  createdAt      DateTime       @default(now())
  options        AnswerOption[]
  topic          Topic          @relation(fields: [topicId], references: [id])
  organization   Organization   @relation(fields: [organizationId], references: [id])
  events         StudyEvent[]
  engineLogs     EngineDecisionLog[]
  masteries      UserMastery[]

  @@index([organizationId, status])
  @@index([topicId, status])
}

model AnswerOption {
  id         String   @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean
  question   Question @relation(fields: [questionId], references: [id])
}

model UserMastery {
  userId         String
  questionId     String
  organizationId String
  easiness       Float        @default(2.5)
  interval       Int          @default(0)
  repetitions    Int          @default(0)
  nextReview     DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
  question       Question     @relation(fields: [questionId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@id([userId, questionId])
  @@index([userId, organizationId, nextReview])
}

model StudyEvent {
  id             String       @id @default(uuid())
  userId         String
  questionId     String
  topicId        String
  organizationId String
  isCorrect      Boolean
  bloomLevel     Int?
  difficulty     Int?
  responseTimeMs Int?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])
  topic          Topic        @relation(fields: [topicId], references: [id])
  question       Question     @relation(fields: [questionId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([organizationId, createdAt])
}

model ShopItem {
  id          String          @id @default(uuid())
  key         String          @unique
  name        String
  description String?
  price       Int
  category    String
  isActive    Boolean         @default(true)
  purchases   Purchase[]
  inventory   UserInventory[]
  roomItems   UserRoomItem[]
}

model UserInventory {
  userId     String
  shopItemId String
  quantity   Int      @default(1)
  shopItem   ShopItem @relation(fields: [shopItemId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@id([userId, shopItemId])
}

model Purchase {
  id         String   @id @default(uuid())
  userId     String
  shopItemId String
  pricePaid  Int
  createdAt  DateTime @default(now())
  shopItem   ShopItem @relation(fields: [shopItemId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model UserRoomItem {
  id         String   @id @default(uuid())
  userId     String
  shopItemId String
  slotKey    String
  posX       Float    @default(0)
  posY       Float    @default(0)
  rotation   Float    @default(0)
  slotIndex  Int?
  shopItem   ShopItem @relation(fields: [shopItemId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, slotKey])
}

model UserCourseProgress {
  userId            String
  courseId          String
  organizationId    String
  currentBloomLevel Int          @default(1)
  streakCorrect     Int          @default(0)
  streakWrong       Int          @default(0)
  organization      Organization @relation(fields: [organizationId], references: [id])
  user              User         @relation(fields: [userId], references: [id])

  @@id([userId, courseId])
  @@index([userId, organizationId])
}

model UserBloomMastery {
  userId       String
  topicId      String
  bloomLevel   Int
  masteryScore Float  @default(0)
  topic        Topic  @relation(fields: [topicId], references: [id])
  user         User   @relation(fields: [userId], references: [id])

  @@id([userId, topicId, bloomLevel])
}

model EngineDecisionLog {
  id              String   @id @default(uuid())
  userId          String
  courseId        String?
  topicId         String?
  questionId      String?
  bloomLevel      Int?
  difficulty      Int?
  selectionReason String?
  strategyVariant String?
  createdAt       DateTime  @default(now())

  user     User?     @relation(fields: [userId], references: [id])
  question Question? @relation(fields: [questionId], references: [id])

  @@index([userId, courseId, createdAt])
  @@index([courseId, createdAt])
}

model StudySession {
  id             String    @id @default(uuid())
  userId         String
  courseId       String?
  startedAt      DateTime  @default(now())
  lastActivityAt DateTime  @default(now())
  endedAt        DateTime?
  questionCount  Int       @default(0)

  user User @relation(fields: [userId], references: [id])

  @@index([userId, courseId, startedAt])
}
